<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>반응 억제 : HAND GO/NO-GO TEST
</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bartle&display=swap" rel="stylesheet">

<style>
@font-face {
  font-family: 'KakaoBigFont';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2503@1.0/KakaoBigSans-Regular.woff2') format('woff2');
  font-weight: 400; font-display: swap;
}
@font-face {
  font-family: 'KakaoBigFont';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2503@1.0/KakaoBigSans-Bold.woff2') format('woff2');
  font-weight: 700; font-display: swap;
}
@font-face {
  font-family: 'KakaoBigFont';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2503@1.0/KakaoBigSans-ExtraBold.woff2') format('woff2');
  font-weight: 800; font-display: swap;
}
</style>

<style>
:root{
  --bg:#ffffff; --ink:#111; --muted:#666; --line:#111;
  --beige:#faf7f0; --paper:#f2efe7; --paper-2:#e7e2d6; --paper-3:#dcd6c7;
  --accent:#e60023; --frame-gap:clamp(16px,3vw,28px);
  --stage-max-h:560px; --stage-min-h:420px;

  /* Modern stimulus palette */
  --go-bg:#f6ecd0; --go-border:#bfa364;
  --nogo-bg:#ffe7ec; --nogo-stroke:#e01a3a;
  --green-bg:#dff6d7; --green-stroke:#3a8b34;
  --blue-bg:#dfeaff;  --blue-stroke:#2a66b3;
  --gray-bg:#f1f1f1;  --gray-stroke:#8a8a8a;

  /* text highlight */
  --beige-strong:#7a5a26;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:'KakaoBigFont',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;overflow:hidden}

/* 프레임 */
.frame{position:fixed;inset:var(--frame-gap);border:1px solid var(--line);pointer-events:none;z-index:1}
.corner{position:fixed;z-index:2;width:24px;height:24px;border:1px solid var(--line);background:transparent}
.corner.tl{left:calc(var(--frame-gap) - 1px);top:calc(var(--frame-gap) - 1px);border-right:none;border-bottom:none}
.corner.tr{right:calc(var(--frame-gap) - 1px);top:calc(var(--frame-gap) - 1px);border-left:none;border-bottom:none}
.corner.bl{left:calc(var(--frame-gap) - 1px);bottom:calc(var(--frame-gap) - 1px);border-right:none;border-top:none}
.corner.br{right:calc(var(--frame-gap) - 1px);bottom:calc(var(--frame-gap) - 1px);border-left:none;border-top:none}

/* 레이아웃 좌(사이드) – 우(게임) */
.shell{
  position:relative;z-index:3;height:calc(100svh - 2*var(--frame-gap));margin:var(--frame-gap);
  display:grid;grid-template-columns:360px 1fr;gap:22px;
}

/* 좌: 사이드 */
.side{
  height:100%;display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;padding:10px;overflow:auto;
  padding-bottom:110px; /* back-btn 공간 확보 */
  position:relative; /* 음악 컨트롤을 위한 상대 위치 */
}
.badge-top{display:inline-flex;align-items:center;gap:10px;padding:6px 12px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#fff}
.badge-top .dot{width:6px;height:6px;background:var(--accent);border-radius:50%}
.eng-title{font-family:"BBH Sans Bartle",system-ui,sans-serif;font-weight:800;letter-spacing:-.01em;line-height:.92;font-size:clamp(26px,3.4vw,42px);border-bottom:1px solid var(--line);padding:6px 0 8px}
h1{margin:0;padding:6px 0 0;font-size:clamp(16px,2.4vw,22px);font-weight:800}
.header-note{color:var(--muted);font-size:12px;margin-top:6px;border-bottom:1px dashed var(--line);padding-bottom:10px}

/* 툴바 */
.toolbar{display:grid;gap:10px;align-content:start;border-bottom:1px solid var(--line);padding-bottom:12px}
.pill{
  background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:12px;display:flex;align-items:center;gap:10px;
}
.pill .label{font-weight:800;white-space:nowrap}
.select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background:#fff; border:1px solid var(--line); border-radius:10px;
  padding:10px 12px; font-weight:700; font-family:'KakaoBigFont',system-ui,sans-serif;
  letter-spacing:.01em; min-width: 230px; flex:1 1 auto;
}
.select:focus{ outline:2px solid #1110; box-shadow: 0 0 0 2px var(--line) inset; }
button, input[type="range"], select{
  background:#fff; color:var(--ink); border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer;
  font-weight:700; width:100%;
}
button.primary{background:var(--accent);color:#fff;border:1px solid var(--line);box-shadow:2px 2px 0 var(--line);font-weight:800}
button.primary:hover{ filter:brightness(1.03); }
button.primary:active{ filter:brightness(.98); }
button.secondary{ background:#fff; border:1px solid var(--line); }

/* 게임 시작 버튼: 강조 */
#btnStart{
  background:#111;color:#fff;text-transform:uppercase;letter-spacing:.02em;font-weight:800;
  font-size:16px; padding:10px 12px; border:2px solid #fff; box-shadow:0 0 0 2px var(--line);
}
#btnStart:hover{ filter:brightness(1.06); }
#btnStart:active{ filter:brightness(.96); }
#btnStart:disabled{opacity:.6;cursor:not-allowed}

/* 상태 버튼 */
.status-pill{
  background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:12px;display:flex;align-items:center;gap:10px;
  font-weight:700; width:100%;
}

/* 안내사항 */
.helpbox{
  border:1px solid var(--line); border-radius:12px; padding:14px;
  font-size:12px; line-height:1.6; background:#fff;
  margin-top:12px;
}

/* 우: 게임 래퍼 */
.stage-wrap{
  position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;
  background:linear-gradient(transparent 39px, rgba(0,0,0,.04) 40px) repeat-y,
             linear-gradient(90deg, transparent 39px, rgba(0,0,0,.04) 40px) repeat-x,
             var(--beige);
  background-size:100% 40px,40px 100%,auto;display:grid;place-items:center;padding:10px;
}
.stage{
  position:relative;height:clamp(var(--stage-min-h),calc(100% - 40px),min(var(--stage-max-h),calc(100svh - 2*var(--frame-gap) - 80px)));
  aspect-ratio:16/9;width:auto;max-width:calc(100% - 20px);border-radius:12px;overflow:hidden;background:var(--paper)
}

/* 비디오/캔버스 */
video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);z-index:1;filter:blur(26px) brightness(.9) saturate(.9) contrast(1.05)}
canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);z-index:2}

/* HUD */
.hud{
  position:absolute;left:12px;top:12px;z-index:30;background:#ffffffcc;border:1px solid var(--line);padding:8px 10px;border-radius:8px;
  font-variant-numeric:tabular-nums;pointer-events:none
}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;font-size:12px}
.row b{font-weight:800}
.meter{position:absolute;left:12px;right:12px;bottom:12px;height:10px;border-radius:999px;background:#fff;border:1px solid var(--line);overflow:hidden;z-index:30}
.meter>span{display:block;height:100%;background:var(--accent);width:0%}
.msg{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#ffffffd0;border:1px solid var(--line);
  padding:10px 14px;border-radius:10px;font-weight:800;opacity:0;transition:opacity .25s;text-align:center;z-index:35;color:var(--ink)
}
.msg.show{opacity:1}

/* 자극 카드 */
.stim{
  position:absolute;left:50%;top:45%;transform:translate(-50%,-50%) scale(.96);
  width:152px;height:152px;border-radius:18px;display:none;place-items:center;
  border:2px solid rgba(17,17,17,.8);
  box-shadow:0 10px 30px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06);
  color:#111;font-weight:800;font-size:40px;letter-spacing:.02em;z-index:40;
  transition:transform .14s ease, box-shadow .2s ease, opacity .14s ease;
  opacity:.98;
}
.stim.show{ transform:translate(-50%,-50%) scale(1); opacity:1; }
.stim.go{display:grid;background:var(--go-bg);border-color:var(--go-border)}
.stim.nogo{display:grid;background:var(--nogo-bg);border-color:var(--nogo-stroke);color:var(--nogo-stroke)}
.stim.decoy-green{display:grid;background:var(--green-bg);border-color:var(--green-stroke);color:#0d6e0d}
.stim.decoy-blue{display:grid;background:var(--blue-bg);border-color:var(--blue-stroke);color:#1d4f98}
.stim.decoy-gray{display:grid;background:var(--gray-bg);border-color:var(--gray-stroke);color:#555}
/* 베이지 NO(스트룹) */
.stim.decoy-beige-no{display:grid;background:var(--go-bg);border-color:var(--go-border);color:var(--beige-strong)}

.result{position:fixed;inset:0;display:none;background:#00000060;z-index:70;padding:0;overflow:auto}
.card{background:var(--paper);border:1px solid var(--line);border-radius:14px;padding:0;width:min(900px,94vw);margin:calc(var(--frame-gap)) auto;box-shadow:8px 8px 0 var(--line);display:grid;grid-template-rows:auto auto auto auto;overflow:hidden}
.report-head{padding:14px 18px 12px;background:repeating-linear-gradient(0deg,rgba(255,255,255,0) 0 28px,rgba(0,0,0,.05) 28px 29px),#fff;border-bottom:1px solid var(--line);display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
.head-left .facility{font-size:12px;letter-spacing:.04em;display:inline-flex;gap:8px;align-items:center}
.head-left .facility .mark{width:10px;height:10px;background:var(--accent);border:1px solid var(--line);display:inline-block}
.head-left h2{margin:6px 0 0;font-size:18px;letter-spacing:.02em}
.head-right{text-align:right;font-size:12px;line-height:1.4}
.head-right .meta{display:grid;grid-template-columns:auto 1fr;gap:4px 10px}
.head-right .meta div:nth-child(odd){color:var(--muted)}
.construct-bar{padding:10px 18px;display:grid;grid-template-columns:auto 1fr;gap:10px 14px;align-items:center;border-bottom:1px dashed var(--line);background:#fff}
.badge{display:inline-block;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:800;background:#fff;color:#000;border:2px solid var(--accent);box-shadow:2px 2px 0 var(--line)}
.kpi-chips{display:flex;gap:8px;flex-wrap:wrap;font-size:12px}
.kpi-chips .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:var(--paper)}
.summary{padding:12px 18px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:0;background:var(--paper)}
.block{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
.block h3{margin:0 0 8px;font-size:13px}
.kv{display:grid;grid-template-columns:1fr auto;row-gap:6px;column-gap:10px;font-size:13px}
.ok{color:#0a7a0a;font-weight:800}.warn{color:#a05b00;font-weight:800}.error{color:var(--accent);font-weight:800}
.assess-wrap{display:grid;grid-template-columns:2fr 1fr;gap:10px;padding:12px 18px;background:#fff;border-top:2px solid var(--line)}
.assess{background:#fff;border:2px solid var(--accent);border-radius:12px;padding:12px;box-shadow: 4px 4px 0 var(--line)}
.assess h3{margin:0 0 10px;font-size:14px}
#rAssess{font-size:16px;font-weight:800;line-height:1.6}
.actions{display:flex;gap:8px;justify-content:center;padding:12px 18px;background:#fff;border-top:1px dashed var(--line);flex-wrap:nowrap}
.actions button{padding:12px 18px;font-size:14px;width:auto;min-width:160px}
.actions .secondary{background:#fff}

/* 가이드 모달 */
.modal{position:fixed;inset:0;display:none;place-items:center;background:#00000040;z-index:80;padding:16px}
.modal .sheet{background:#fff;border:1px solid var(--line);border-radius:14px;width:min(640px,92vw);padding:18px 18px 16px;box-shadow:8px 8px 0 var(--line)}
.modal h2{margin:0 0 10px;text-align:center}
.modal .guide{background:#fff;border:1px dashed var(--line);border-radius:12px;padding:14px 14px 10px;display:grid;gap:8px}
.modal .guide h3{margin:0;font-size:14px;text-align:center}
.modal ul{margin:0 0 6px 18px;padding:0;line-height:1.6}
.modal .foot{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.modal small{color:var(--muted)}
.key{
  display:inline-block; padding:6px 10px; border-radius:10px; font-weight:800;
  background: var(--go-bg); color: var(--beige-strong);
  border:1px solid var(--go-border); box-shadow: 2px 2px 0 var(--line);
}
.key-center{ display:flex; justify-content:center; margin-top:8px; }

/* 뒤로가기 버튼 */
.back-btn{
  position:fixed; left:calc(var(--frame-gap) + 12px); bottom:calc(var(--frame-gap) + 12px);
  width:72px; height:72px; border-radius:50%;
  background:var(--accent); color:#fff;
  border:2px solid var(--line); display:flex; align-items:center; justify-content:center;
  font-size:28px; font-weight:800; cursor:pointer; z-index:90;
  box-shadow:4px 4px 0 var(--line);
  transition:transform .08s ease, box-shadow .2s ease, filter .2s ease;
  text-decoration:none;
}
.back-btn:hover{ filter:brightness(1.08); }
.back-btn:active{ transform:translateY(1px); box-shadow:2px 2px 0 var(--line); }

/* ===== 음악 컨트롤 ===== */
.music-controls{
  position:absolute;
  left:50%;
  top:60px;
  transform:translateX(-50%);
  display:flex;
  align-items:center;
  gap:8px;
  z-index:20;
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 12px;
  box-shadow:2px 2px 0 var(--line);
  width:fit-content;
}

.music-toggle{
  width:32px;
  height:32px;
  border-radius:50%;
  background:var(--accent);
  color:#fff;
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:14px;
  font-weight:800;
  transition:all 0.2s ease;
}

.music-toggle:hover{
  filter:brightness(1.1);
}

.music-toggle:active{
  transform:scale(0.95);
}

.music-toggle.muted{
  background:#666;
}

.volume-slider{
  width:60px;
  height:4px;
  background:#ddd;
  border-radius:2px;
  outline:none;
  cursor:pointer;
  appearance:none;
  -webkit-appearance:none;
}

.volume-slider::-webkit-slider-thumb{
  appearance:none;
  -webkit-appearance:none;
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--accent);
  border:1px solid var(--line);
  cursor:pointer;
}

.volume-slider::-moz-range-thumb{
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--accent);
  border:1px solid var(--line);
  cursor:pointer;
}

@media (max-width:840px){
  .shell{grid-template-columns:300px 1fr;gap:12px}
  .eng-title{font-size:clamp(22px,4.4vw,34px)}
  .summary{grid-template-columns:1fr}
  .assess-wrap{grid-template-columns:1fr}
  .hud{max-width:72%}
}
</style>
</head>
<body>

<!-- 프레임 -->
<div class="frame" aria-hidden="true"></div>
<div class="corner tl" aria-hidden="true"></div>
<div class="corner tr" aria-hidden="true"></div>
<div class="corner bl" aria-hidden="true"></div>
<div class="corner br" aria-hidden="true"></div>

<!-- 뒤로가기 -->
<a href="game.html" class="back-btn" id="backBtn" aria-label="이전 화면으로 돌아가기">←</a>


<div class="shell">
  <!-- 좌: 사이드 -->
  <aside class="side" aria-label="설정 및 안내">
    <div>
      <span class="badge-top"><span class="dot"></span> ADHD SELF-CHECK</span>
      <div class="eng-title">HAND GO/NO-GO TEST</div>
      <h1>손 들기 — 반응 억제 자가 점검</h1>
      <p class="header-note">이는 주의/억제 패턴을 살피는 참고용 도구이며, 의료 진단을 대체하지 않습니다.</p>
    </div>

    <div class="toolbar">
      <button id="btnCam" class="primary">카메라 시작</button>

      <label class="pill"><span class="label">모드</span>
        <select id="mode" class="select">
          <option value="standard" selected>Standard: 베이지 GO만 반응</option>
          <option value="mix">Fake Mix: 페이크 다수(베이지 X/컬러 GO)</option>
          <option value="stroop">Stroop: 텍스트/색상 충돌</option>
        </select>
      </label>

      <button id="btnStart">게임 시작(60초)</button>

      <!-- 상태 -->
      <div class="status-pill">상태: <span id="status">대기</span></div>
    </div>

    <!-- 안내사항 -->
    <div class="helpbox">
      <div>• HTTPS(또는 Live Server)에서 실행 → 카메라 허용</div>
      <div>• <span style="color:var(--beige-strong); font-weight:800;">오직 베이지 GO</span>일 때만 손을 들기</div>
      <div>• 그 외(붉은 X, 색 다른 GO, 베이지 X, 회색 박스 등)는 가만히</div>
    </div>

    <div></div>
  </aside>

  <!-- 우: 게임 -->
  <section class="stage-wrap" aria-label="게임 화면">
    <!-- 음악 컨트롤 -->
    <div class="music-controls" id="musicControls">
      <button class="music-toggle" id="musicToggle" aria-label="음악 켜기/끄기">♪</button>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" aria-label="음량 조절">
    </div>
    <div class="stage">
      <div class="hud" id="hud">
        <div class="row">
          <span>TIME <b id="timeLeft">60.0s</b></span>
          <span>HIT <b id="hit">0</b></span>
          <span>MISS <b id="miss">0</b></span>
          <span>COMM <b id="comm">0</b></span>
          <span>RT <b id="rt">-</b></span>
          <span>RTσ <b id="rtv">-</b></span>
        </div>
        <div class="row"><span style="font-size:12px;color:var(--muted)">규칙: <b>베이지 GO에만 반응</b> / 나머지는 정지</span></div>
      </div>

      <div class="meter"><span id="bar"></span></div>
      <div id="msg" class="msg"></div>

      <video id="video" playsinline muted></video>
      <canvas id="overlay"></canvas>

      <!-- 자극 -->
      <div id="stim" class="stim" aria-live="polite"></div>

      <!-- 결과 카드 -->
      <div id="result" class="result">
        <div class="card">
          <div class="report-head">
            <div class="head-left">
              <div class="facility"><span class="mark"></span> FOCUS BREAKOUT LAB</div>
              <h2>세션 결과 진단서</h2>
            </div>
            <div class="head-right">
              <div class="meta">
                <div>세션 길이</div><div>60초</div>
                <div>리포트 ID</div><div>#HGNG-2025-XXXX</div>
                <div>생성 시각</div><div><span style="opacity:.85;">브라우저 시각 기준</span></div>
              </div>
            </div>
          </div>

          <div class="construct-bar">
            <span class="badge" id="badgeConstruct">평가 초점: 반응 억제 + 지속 주의 + 선택적 주의</span>
            <div class="kpi-chips">
              <span class="chip">MODE: <b id="rMode">-</b></span>
              <span class="chip">HIT: <b id="rHit">0</b></span>
              <span class="chip">MISS: <b id="rMiss">0</b></span>
              <span class="chip">COMM: <b id="rComm">0</b></span>
              <span class="chip">RT: <b id="rRT">-</b></span>
              <span class="chip">RTσ: <b id="rRTV">-</b></span>
              <span class="chip">ACC%: <b id="rAcc">-</b></span>
              <span class="chip">COMM%: <b id="rCommRate">-</b></span>
              <span class="chip">MISS%: <b id="rMissRate">-</b></span>
              <span class="chip">N Trials: <b id="rN">-</b></span>
            </div>
          </div>

          <div class="summary">
            <div class="block">
              <h3>요약</h3>
              <div class="kv">
                <div>정답(HIT)</div><div id="rHit2">0</div>
                <div>놓침(Omission)</div><div id="rMiss2" class="warn">0</div>
                <div>금지/페이크 반응(Commission)</div><div id="rComm2" class="error">0</div>
              </div>
            </div>
            <div class="block">
              <h3>반응 시간</h3>
              <div class="kv">
                <div>평균 RT</div><div id="rRT2">-</div>
                <div>변동성 RTσ</div><div id="rRTV2">-</div>
              </div>
            </div>
            <div class="block">
              <h3>참고 기준(모드 보정)</h3>
              <ul id="refList" style="font-size:12px;line-height:1.5;margin:6px 0 0 18px;padding:0;"></ul>
            </div>
          </div>

          <div class="assess-wrap">
            <div class="assess">
              <h3>자동 해석(참고용)</h3>
              <div id="rAssess" class="warn">-</div>
              <div class="help">※ 본 결과는 자가 점검 참고용이며 의료 진단을 대체하지 않습니다.</div>
            </div>
            <div class="assess">
              <h3>요약 메모</h3>
              <div style="font-size:12px;line-height:1.6;">
                • COMM은 억제 실패/페이크 반응을 포함합니다.<br/>
                • MISS는 선택적·지속 주의 누락과 관련됩니다.<br/>
                • 비율 지표(COMM%/MISS%)는 모드 난이도와 자극 구성 차이를 보정합니다.
              </div>
            </div>
          </div>

          <div class="actions">
            <button id="btnRestart">다시 하기</button>
            <button id="btnClose" class="secondary">닫기</button>
            <button id="btnSavePNG" class="secondary">결과 저장</button>
          </div>
        </div>
      </div>
      <!-- 결과 카드 끝 -->
    </div>
  </section>
</div>

<!-- 가이드 모달 (모드별 동적) -->
<div id="guideModal" class="modal">
  <div class="sheet">
    <h2 id="guideTitle">플레이 가이드</h2>
    <div class="guide">
      <h3 id="guideSubtitle">-</h3>
      <ul id="guideList"></ul>
      <div class="key-center">
        <span class="key">베이지 GO에만 손 들기</span>
      </div>
    </div>
    <div class="foot">
      <button id="btnGuideCancel" class="secondary">취소</button>
      <button id="btnGuideStart" class="primary">플레이 시작</button>
    </div>
    <small id="guideNote" style="display:block;text-align:center;margin-top:8px;">Tip: 화면 우상단 방향으로 손을 들면 인식이 쉬워요. (거울 모드)</small>
  </div>
</div>

<script type="module">
  import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.13";

  const els = {
    btnCam: document.getElementById('btnCam'),
    btnStart: document.getElementById('btnStart'),
    mode: document.getElementById('mode'),
    status: document.getElementById('status'),
    video: document.getElementById('video'),
    canvas: document.getElementById('overlay'),
    timeLeft: document.getElementById('timeLeft'),
    hit: document.getElementById('hit'), miss: document.getElementById('miss'), comm: document.getElementById('comm'),
    rt: document.getElementById('rt'), rtv: document.getElementById('rtv'),
    bar: document.getElementById('bar'), msg: document.getElementById('msg'),
    stim: document.getElementById('stim'),
    result: document.getElementById('result'),
    rMode: document.getElementById('rMode'),
    rHit: document.getElementById('rHit'), rMiss: document.getElementById('rMiss'), rComm: document.getElementById('rComm'),
    rRT: document.getElementById('rRT'), rRTV: document.getElementById('rRTV'), rAcc: document.getElementById('rAcc'), rN: document.getElementById('rN'),
    rHit2: document.getElementById('rHit2'), rMiss2: document.getElementById('rMiss2'), rComm2: document.getElementById('rComm2'),
    rRT2: document.getElementById('rRT2'), rRTV2: document.getElementById('rRTV2'),
    rAssess: document.getElementById('rAssess'),
    refList: document.getElementById('refList'),
    rCommRate: document.getElementById('rCommRate'),
    rMissRate: document.getElementById('rMissRate'),
    btnSavePNG: document.getElementById('btnSavePNG'),
    guideModal: document.getElementById('guideModal'),
    btnGuideStart: document.getElementById('btnGuideStart'),
    btnGuideCancel: document.getElementById('btnGuideCancel'),
    guideTitle: document.getElementById('guideTitle'),
    guideSubtitle: document.getElementById('guideSubtitle'),
    guideList: document.getElementById('guideList'),
    backBtn: document.getElementById('backBtn'),
    badgeConstruct: document.getElementById('badgeConstruct'),
  };

  const SESSION_SEC = 60;
  let handLandmarker = null, running = false, playing = false;
  let lastTime = performance.now(), sessionStart = 0, elapsed = 0;

  // 메트릭
  let hits=0, misses=0, commissions=0, nTrials=0;
  let goTrials=0, nonGoTrials=0; // 분모용
  const rtList = [];

  // 개인 적응(워밍업 → 반응 임계치)
  const WARMUP_N = 8;
  const warmupRT = [];
  let responseMin = 0.22; // 기본 임계(오탐 방지)
  function recomputeResponseMin(){
    if (warmupRT.length >= WARMUP_N){
      const mean = warmupRT.reduce((a,b)=>a+b,0)/warmupRT.length;
      // 개인 RT의 38% (하한 0.18, 상한 0.30)
      responseMin = Math.max(0.18, Math.min(0.30, 0.38 * mean));
    }
  }

  // 손 인식(스무딩)
  let raised=false, framesUp=0, framesDown=0, lastResponseAt=0;

  function setStatus(t, cls=""){ els.status.textContent=t; els.status.className=cls; }
  function fitCanvas(){
    const r = els.video.getBoundingClientRect();
    els.canvas.width = Math.max(1, r.width * devicePixelRatio);
    els.canvas.height= Math.max(1, r.height * devicePixelRatio);
  }

  /* ===== 모드별 설정 (난이도 대폭 상향) ===== */
  function modeConfig(){
    const m = els.mode.value;
    if (m === "mix"){
      // ★ 템포 극대화: ISI 대폭 단축, 자극 시간 단축, 페이크 비중↑
      return {
        name:"Fake Mix",
        isi:[0.18,0.50],        // 0.38~0.90 → 0.18~0.50
        stim:0.65,              // 0.95 → 0.65
        p:{go:0.28, nogo:0.28, decoy:0.44},  // 페이크 비중 35% → 44%
        decoys:["green","blue","gray","beige_x","green","blue"],
        stroop:false
      };
    }
    if (m === "stroop"){
      // ★ 베이지 NO 비중 극대화 + 극한 템포
      return {
        name:"Stroop",
        isi:[0.15,0.45],        // 0.30~0.80 → 0.15~0.45
        stim:0.60,              // 0.90 → 0.60
        p:{go:0.22, nogo:0.18, decoy:0.60},  // 데코이 46% → 60%
        decoys:["beige_no","beige_no","beige_no","beige_no","stroop_bad","blue","green","beige_x","beige_no"],
        stroop:true
      };
    }
    // Standard
    return {
      name:"Standard",
      isi:[0.22,0.60],          // 0.38~0.90 → 0.22~0.60
      stim:0.75,                // 1.00 → 0.75
      p:{go:0.48, nogo:0.52, decoy:0.00},  // nogo 비중 42% → 52%
      decoys:[],
      stroop:false
    };
  }

  function guideForMode(){
    const m = els.mode.value;
    if (m === "mix") return {
      title:"플레이 가이드 — Fake Mix",
      subtitle:"오직 베이지 GO만 반응 — 다양한 페이크에 속지 않기",
      bullets:[
        "<span class='key'>베이지 GO에만 손 들기</span> (베이지 X/녹·파·회색 GO는 모두 페이크)",
        "반응 창: 개인 적응 기준 적용(기본 0.22s)",
        "집중 포인트: 선택적 주의(타깃 식별) + 억제",
        "<b>난이도 상승:</b> 빠른 템포 + 페이크 비중 증가"
      ]
    };
    if (m === "stroop") return {
      title:"플레이 가이드 — Stroop",
      subtitle:"텍스트/색상 충돌 — 의미 vs 형태의 간섭(난이도↑↑)",
      bullets:[
        "<span class='key'>베이지 GO에만 손 들기</span> (<b>베이지 'NO'</b> 비중 극대화, 파란 'NO', 파란/초록 박스, 베이지 X 등 간섭 다수)",
        "반응 창: 개인 적응 기준 적용(기본 0.22s, 워밍업 후 자동 보정)",
        "집중 포인트: 간섭 저항 + 억제",
        "<b>난이도 최고:</b> 극한 템포 + 의미 간섭 60%"
      ]
    };
    return {
      title:"플레이 가이드 — Standard",
      subtitle:"베이지 GO / No-Go(붉은 X)",
      bullets:[
        "<span class='key'>베이지 GO에만 손 들기</span>, 붉은 X는 정지",
        "반응 창: 개인 적응 기준 적용(기본 0.22s)",
        "집중 포인트: 억제 + 지속 주의의 기본",
        "<b>난이도 상승:</b> 빠른 템포 + No-Go 비중 증가"
      ]
    };
  }

  function refLinesForMode(){
    const m = els.mode.value;
    if (m === "mix") return [
      "<b>COMM</b> 0–4: 양호 / 10회↑: 억제 저하(페이크 다수 + 빠른 템포)",
      "<b>MISS</b> 0–5: 양호 / 10회↑: 선택적 주의 저하",
      "<b>COMM%</b> 안정 ≤ 12% / 높음 ≥ 22%",
      "<b>MISS%</b> 안정 ≤ 15% / 높음 ≥ 35%",
      "<b>RTσ</b> ≤ 0.55s: 변동성 낮음"
    ];
    if (m === "stroop") return [
      "<b>COMM</b> 0–5: 양호 / 12회↑: 간섭 저항 저하(의미 페이크 60% + 극한 템포)",
      "<b>MISS</b> 0–6: 양호 / 12회↑: 선택적 주의 저하",
      "<b>COMM%</b> 안정 ≤ 12% / 높음 ≥ 22%",
      "<b>MISS%</b> 안정 ≤ 15% / 높음 ≥ 35%",
      "<b>RTσ</b> ≤ 0.55s: 변동성 낮음"
    ];
    return [
      "<b>COMM</b> 0–3: 양호 / 8회↑: 억제 저하",
      "<b>MISS</b> 0–4: 양호 / 9회↑: 주의 누락",
      "<b>COMM%</b> 안정 ≤ 8% / 높음 ≥ 18%",
      "<b>MISS%</b> 안정 ≤ 12% / 높음 ≥ 30%",
      "<b>RTσ</b> ≤ 0.45s: 변동성 낮음"
    ];
  }

  function assessByMode({misses, commissions, rtStd, commRate, missRate}){
    const m = els.mode.value;
    let level="중간", tip="모드 조건에서 약간의 변동. 짧은 집중-휴식 루틴 권장.";

    if (m === "mix"){
      // ★ 난이도↑에 따른 판정 완화
      const high   = (commissions>=10 || misses>=10 || rtStd>1.2 || commRate>=0.22 || missRate>=0.35);
      const stable = (commissions<=4 && misses<=5 && (rtStd||0)<=0.55 && commRate<=0.12 && missRate<=0.15);
      level  = high ? "높음" : (stable ? "안정" : "중간");
      tip    = high ? "빠른 템포에서 페이크에 빈번히 반응/놓침. 타깃 규칙 재확인·자극 단순화."
              : stable ? "빠른 페이스에서도 선택적 주의·억제가 안정적입니다."
              : "가끔 페이크에 반응. 규칙 문구를 눈으로 읽고 행동 지연 연습.";
    } else if (m === "stroop"){
      // ★ 최고 난이도 판정 완화
      const high   = (commissions>=12 || misses>=12 || rtStd>1.2 || commRate>=0.22 || missRate>=0.35);
      const stable = (commissions<=5 && misses<=6 && (rtStd||0)<=0.55 && commRate<=0.12 && missRate<=0.15);
      level  = high ? "높음" : (stable ? "안정" : "중간");
      tip    = high ? "극한 템포 + 의미 간섭('NO')에 취약. 규칙(베이지만) 반복·시선 고정 추천."
              : stable ? "극한 간섭 환경에서도 억제·선택 주의가 양호합니다."
              : "간섭 상황에서 일시적 혼선. 속으로 규칙 낭독이 도움.";
    } else {
      // ★ Standard 판정 완화
      const high   = (commissions>=8 || misses>=9 || rtStd>1.0 || commRate>=0.18 || missRate>=0.30);
      const stable = (commissions<=3 && misses<=4 && (rtStd||0)<=0.45 && commRate<=0.08 && missRate<=0.12);
      level  = high ? "높음" : (stable ? "안정" : "중간");
      tip    = high ? "빠른 템포에서 억제 실패/놓침이 누적. 자극 단순화·호흡 페이싱."
              : stable ? "빠른 페이스에서도 기본 억제·지속 주의가 양호합니다."
              : "간헐적 변동. 3–4분 집중/1분 휴식 루틴 권장.";
    }
    return {level, tip};
  }

  // 유틸
  function randBetween(a,b){ return a + Math.random()*(b-a); }

  // Trial 생성
  function newTrial(){
    const cfg = modeConfig();
    const r = Math.random();
    let type="go", decoy=null;
    if (r < cfg.p.go){ type="go"; }
    else if (r < cfg.p.go + cfg.p.nogo){ type="nogo"; }
    else { type="decoy"; decoy = cfg.decoys[Math.floor(Math.random()*cfg.decoys.length)] || "green"; }
    return { type, decoy, isi:randBetween(cfg.isi[0], cfg.isi[1]), stimDur:cfg.stim, phase:"isi", t:0, responded:false, rt:null };
  }
  let current = null;

  async function setupHand(){
    setStatus("모델 로딩 중…");
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.13/wasm");
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
      baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task" },
      runningMode:"VIDEO", numHands:1
    });
    setStatus("준비됨","ok");
  }

  async function startCamera(){
    try{
      setStatus("카메라 요청 중…");
      const stream = await navigator.mediaDevices.getUserMedia({ video:{width:1280,height:720,facingMode:"user"}, audio:false });
      els.video.srcObject = stream; await els.video.play();
      fitCanvas(); addEventListener('resize', fitCanvas, {passive:true});
      if (!handLandmarker) await setupHand();
      running = true; setStatus("카메라 연결됨","ok");
      requestAnimationFrame(loop);
    }catch(e){ console.error(e); setStatus("카메라 실패: 권한/HTTPS 확인","error"); }
  }

  // 손 들기 판정
  function isRaised(res){
    if (!res?.landmarks?.length) return false;
    const lm = res.landmarks[0], tip = lm[8], wrist = lm[0];
    if (!tip || !wrist) return false;
    const relative = tip.y < wrist.y - 0.10;
    const absolute = tip.y <= 0.58;
    return relative || absolute;
  }

  function svgX(size=90){
    return `
      <svg width="${size}" height="${size}" viewBox="0 0 90 90" aria-hidden="true">
        <line x1="10" y1="10" x2="80" y2="80" stroke="currentColor" stroke-width="10" stroke-linecap="round"/>
        <line x1="80" y1="10" x2="10" y2="80" stroke="currentColor" stroke-width="10" stroke-linecap="round"/>
      </svg>`;
  }

  function showStim(t){
    els.stim.className = "stim";
    els.stim.textContent = "";
    els.stim.innerHTML = "";

    if (t.type === "go"){
      els.stim.classList.add("go");
      els.stim.textContent = "GO";
    } else if (t.type === "nogo"){
      els.stim.classList.add("nogo");
      els.stim.innerHTML = svgX(90);
    } else { // decoy
      if (t.decoy === "green"){ els.stim.classList.add("decoy-green"); els.stim.textContent="GO"; }
      else if (t.decoy === "blue"){ els.stim.classList.add("decoy-blue"); els.stim.textContent="GO"; }
      else if (t.decoy === "gray"){ els.stim.classList.add("decoy-gray"); els.stim.textContent="GO"; }
      else if (t.decoy === "beige_x"){ els.stim.classList.add("go"); els.stim.innerHTML = svgX(90); }
      else if (t.decoy === "stroop_bad"){ els.stim.classList.add("decoy-blue"); els.stim.textContent="NO"; }      // 파란 NO
      else if (t.decoy === "beige_no"){ els.stim.classList.add("decoy-beige-no"); els.stim.textContent="NO"; }   // 베이지 NO
      else { els.stim.classList.add("decoy-gray"); els.stim.textContent="GO"; }
    }
    els.stim.style.display = "grid";
    requestAnimationFrame(()=> els.stim.classList.add('show'));
  }
  function hideStim(){
    els.stim.classList.remove('show');
    els.stim.style.display="none";
    els.stim.textContent=""; els.stim.innerHTML=""; els.stim.className="stim";
  }

  function showMsg(text, dur=700){
    els.msg.textContent=text; els.msg.classList.add('show');
    clearTimeout(showMsg.tid); showMsg.tid = setTimeout(()=>els.msg.classList.remove('show'), dur);
  }

  function updateHUD(){
    els.timeLeft.textContent = (Math.max(0, SESSION_SEC - elapsed)).toFixed(1)+"s";
    els.hit.textContent = hits; els.miss.textContent = misses; els.comm.textContent = commissions;
    const mean = rtList.length ? rtList.reduce((a,b)=>a+b,0)/rtList.length : 0;
    const std  = rtList.length ? Math.sqrt(rtList.reduce((a,b)=>a+(b-mean)*(b-mean),0)/rtList.length) : 0;
    els.rt.textContent  = rtList.length ? mean.toFixed(2)+"s" : "-";
    els.rtv.textContent = rtList.length ? std.toFixed(2)+"s"  : "-";
    els.bar.style.width = Math.min(100,(elapsed/SESSION_SEC)*100)+"%";
  }

  function endSession(){
    playing=false;
    const mean = rtList.length ? rtList.reduce((a,b)=>a+b,0)/rtList.length : 0;
    const std  = rtList.length ? Math.sqrt(rtList.reduce((a,b)=>a+(b-mean)*(b-mean),0)/rtList.length) : 0;
    const acc = (hits + (nTrials - hits - misses - commissions)) / Math.max(1, nTrials);

    const commRate = nonGoTrials ? (commissions / nonGoTrials) : 0;
    const missRate = goTrials ? (misses / goTrials) : 0;

    const cfg = modeConfig();
    els.rMode.textContent = cfg.name;
    els.rHit.textContent=hits; els.rHit2.textContent=hits;
    els.rMiss.textContent=misses; els.rMiss2.textContent=misses;
    els.rComm.textContent=commissions; els.rComm2.textContent=commissions;
    els.rRT.textContent = rtList.length ? mean.toFixed(2)+"s" : "-";
    els.rRT2.textContent= rtList.length ? mean.toFixed(2)+"s" : "-";
    els.rRTV.textContent= rtList.length ? std.toFixed(2)+"s" : "-";
    els.rRTV2.textContent= rtList.length ? std.toFixed(2)+"s" : "-";
    els.rAcc.textContent = isFinite(acc) ? Math.round(acc*100)+"%" : "-";
    els.rN.textContent = nTrials;
    els.rCommRate.textContent = nonGoTrials ? `${Math.round(commRate*100)}% of ${nonGoTrials}` : "-";
    els.rMissRate.textContent = goTrials ? `${Math.round(missRate*100)}% of ${goTrials}` : "-";

    els.refList.innerHTML = refLinesForMode().map(s=>`<li>${s}</li>`).join("");

    const a = assessByMode({misses, commissions, rtStd: std, commRate, missRate});
    els.rAssess.textContent = `ADHD 의심 단계: ${a.level} — ${a.tip}`;
    els.rAssess.className = (a.level==="안정")?"ok":(a.level==="높음")?"error":"warn";

    els.result.style.display="grid";
    
    // 게임 결과 표시 시 음악 종료
    if (window.musicControls) {
      window.musicControls.stop();
    }
  }

  function exportPNG(){
    // 진단서 결과 카드를 캡처
    const resultCard = document.querySelector('.card');
    if (!resultCard) {
      console.error('결과 카드를 찾을 수 없습니다.');
      return;
    }

    // html2canvas 라이브러리를 동적으로 로드
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
    script.onload = () => {
      html2canvas(resultCard, {
        backgroundColor: '#f2efe7',
        scale: 2,
        useCORS: true,
        allowTaint: true,
        width: resultCard.offsetWidth,
        height: resultCard.offsetHeight
      }).then(canvas => {
        const url = canvas.toDataURL("image/png");
        const a = document.createElement('a');
        a.href = url;
        a.download = `hand-gng-result_${Date.now()}.png`;
        a.click();
      }).catch(err => {
        console.error('캡처 실패:', err);
        alert('결과 저장에 실패했습니다. 다시 시도해주세요.');
      });
    };
    script.onerror = () => {
      console.error('html2canvas 로드 실패');
      alert('결과 저장 기능을 로드할 수 없습니다.');
    };
    document.head.appendChild(script);
  }

  function startSession(){
    hits=0; misses=0; commissions=0; nTrials=0;
    goTrials=0; nonGoTrials=0;
    rtList.length=0; warmupRT.length=0; responseMin=0.22;

    elapsed=0; sessionStart=performance.now(); els.bar.style.width="0%";
    framesUp=0; framesDown=0; raised=false; lastResponseAt=0;
    current = newTrial(); // ISI부터
    showMsg("시작: 베이지 GO만 반응", 900);
    playing=true;
  }

  function loop(now){
    if (!running) return;

    let res=null;
    try{ if (handLandmarker && els.video.readyState>=2) res = handLandmarker.detectForVideo(els.video, now); }
    catch(e){ console.error(e); setStatus("추적 오류(권한/조명 확인)","error"); }

    // 스무딩: 3프레임 연속 + 200ms 불응기
    const raisedNow = isRaised(res);
    if (raisedNow){ framesUp++; framesDown=0; } else { framesDown++; framesUp=0; }
    const edgeUp = (!raised && framesUp>=3 && (performance.now()-lastResponseAt)>200);
    if (edgeUp) { raised=true; lastResponseAt=performance.now(); }
    if (framesDown>=2) raised=false;

    const dt = Math.min(0.035,(now - lastTime)/1000); lastTime=now;

    if (playing){
      elapsed = (now - sessionStart)/1000;
      if (elapsed >= SESSION_SEC){
        hideStim(); updateHUD(); endSession();
      } else {
        if (current.phase==="isi"){
          hideStim();
          current.t += dt;
          if (current.t >= current.isi){
            current.phase="stim"; current.t=0; current.responded=false; current.rt=null; nTrials++;

            // 카테고리 분모 카운트
            if (current.type === "go") goTrials++;
            else nonGoTrials++;

            showStim(current);
          }
        } else if (current.phase==="stim"){
          current.t += dt;

          // 개인 적응 반응 임계 적용
          if (!current.responded && current.t>=responseMin && raised){
            current.responded=true; current.rt=current.t;

            if (current.type === "go"){
              hits++; rtList.push(current.rt);
              // 워밍업 수집
              if (warmupRT.length < WARMUP_N) { warmupRT.push(current.rt); recomputeResponseMin(); }
            } else {
              commissions++; showMsg("금지/페이크 반응(Commission)", 800);
            }

            current = newTrial(); // 즉시 다음
          }

          if (current.t >= current.stimDur){
            if (current.type === "go" && current.rt==null){
              misses++; showMsg("놓침(Omission)", 800);
            }
            current = newTrial();
          }
        }
        updateHUD();
      }
    }

    requestAnimationFrame(loop);
  }

  /* 모달(모드별) */
  function openGuide(){
    const g = guideForMode();
    document.getElementById('guideTitle').textContent = g.title;
    document.getElementById('guideSubtitle').textContent = g.subtitle;
    document.getElementById('guideList').innerHTML = g.bullets.map(s=>`<li>${s}</li>`).join("");
    els.guideModal.style.display = "grid";
  }
  function closeGuide(){ els.guideModal.style.display = "none"; }

  // 이벤트
  document.getElementById('btnCam').addEventListener('click', startCamera);
  document.getElementById('btnStart').addEventListener('click', openGuide);
  document.getElementById('btnGuideCancel').addEventListener('click', closeGuide);
  document.getElementById('btnGuideStart').addEventListener('click', ()=>{ 
    closeGuide(); 
    startSession();
    
    // 음악 처음부터 재생
    if (window.musicControls && !window.musicControls.isMuted) {
      window.musicControls.reset();
      window.musicControls.play();
    }
  });
  document.getElementById('btnSavePNG').addEventListener('click', exportPNG);
  document.getElementById('backBtn').addEventListener('click', ()=> history.back());

  // 모드 변경 시 배지 갱신
  document.getElementById('mode').addEventListener('change', ()=>{
    const cfg = modeConfig();
    document.getElementById('badgeConstruct').textContent =
      `평가 초점: 반응 억제 + 지속 주의 + 선택적 주의 (${cfg.name})`;
  });

  document.addEventListener('click', (e)=>{
    if (e.target.id==='btnRestart'){ 
      document.getElementById('result').style.display="none"; 
      startSession();
      
      // 음악 다시 시작
      if (window.musicControls && !window.musicControls.isMuted) {
        window.musicControls.reset();
        window.musicControls.play();
      }
    }
    if (e.target.id==='btnClose'){ document.getElementById('result').style.display="none"; }
  });

  addEventListener('pagehide', ()=>{
    running=false; const s=els.video.srcObject; s && s.getTracks().forEach(t=>t.stop());
    handLandmarker && handLandmarker.close && handLandmarker.close();
  });

  // 최초 루프
  requestAnimationFrame(loop);

  /* ===== 음악 컨트롤 시스템 ===== */
  window.musicControls = {
    audio: null,
    isPlaying: false,
    isMuted: false,
    volume: 0.5,
    
    init() {
      this.audio = new Audio('game2.mp3');
      this.audio.loop = true;
      this.audio.volume = this.volume;
      
      // 게임 시작 시 음악 재생 (가이드 시작 버튼, 처음부터)
      document.getElementById('btnGuideStart').addEventListener('click', () => {
        if (!this.isMuted) {
          this.reset();
          this.play();
        }
      });
      
      // 게임 종료 시 음악 완전 종료
      document.addEventListener('gameEnd', () => {
        this.stop();
      });
      
      // 토글 버튼
      document.getElementById('musicToggle').addEventListener('click', () => {
        this.toggle();
      });
      
      // 볼륨 슬라이더
      document.getElementById('volumeSlider').addEventListener('input', (e) => {
        this.setVolume(e.target.value / 100);
      });
    },
    
    play() {
      if (this.audio && !this.isMuted) {
        this.audio.play().catch(e => console.log('Audio play failed:', e));
        this.isPlaying = true;
        this.updateToggleButton();
      }
    },
    
    stop() {
      if (this.audio) {
        this.audio.pause();
        // currentTime을 0으로 리셋하지 않음 (멈춘 부분 유지)
        this.isPlaying = false;
        this.updateToggleButton();
      }
    },
    
    reset() {
      if (this.audio) {
        this.audio.pause();
        this.audio.currentTime = 0; // 게임 종료 시에만 처음부터 시작
        this.isPlaying = false;
        this.updateToggleButton();
      }
    },
    
    toggle() {
      this.isMuted = !this.isMuted;
      if (this.isMuted) {
        this.stop();
      } else {
        this.play();
      }
      this.updateToggleButton();
    },
    
    setVolume(volume) {
      this.volume = volume;
      if (this.audio) {
        this.audio.volume = this.isMuted ? 0 : this.volume;
      }
    },
    
    updateToggleButton() {
      const toggle = document.getElementById('musicToggle');
      if (this.isMuted) {
        toggle.classList.add('muted');
        toggle.textContent = '♫';
      } else {
        toggle.classList.remove('muted');
        toggle.textContent = '♪';
      }
    }
  };
  
  // 음악 컨트롤 초기화
  musicControls.init();
</script>
</body>
</html>